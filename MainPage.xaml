<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MauiApp.ViewModels"
             xmlns:models="clr-namespace:MauiApp.Models"
             x:Class="MauiApp.MainPage"
             Title="화면 엿보기 방지"
             x:DataType="vm:MainViewModel">

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- 헤더 -->
        <Frame BackgroundColor="{StaticResource Primary}" 
               Padding="20"
               CornerRadius="0">
            <VerticalStackLayout Spacing="10">
                <Label Text="👁️ 화면 엿보기 방지" 
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="White"
                       HorizontalOptions="Center"/>
                <Label Text="{Binding StatusMessage}"
                       FontSize="14"
                       TextColor="White"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Frame>

        <!-- 메인 콘텐츠 -->
        <ScrollView Grid.Row="1" Padding="20">
            <VerticalStackLayout Spacing="20">
                
                <!-- 감지 상태 카드 -->
                <Frame BorderColor="{StaticResource Primary}" 
                       HasShadow="True"
                       Padding="15"
                       CornerRadius="10">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="감지 상태" 
                               FontSize="18"
                               FontAttributes="Bold"/>
                        
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                            <Label Text="엿보기 감지" 
                                   VerticalOptions="Center"
                                   FontSize="16"/>
                            <Switch Grid.Column="1" 
                                    IsToggled="{Binding IsDetectionActive}"
                                    OnColor="{StaticResource Primary}"
                                    ThumbColor="White"/>
                        </Grid>

                        <BoxView HeightRequest="1" 
                                 BackgroundColor="{StaticResource Gray300}"/>

                        <HorizontalStackLayout Spacing="10">
                            <Label Text="감지 횟수:" 
                                   FontSize="14"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding PeekingCount}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- 모드 선택 카드 -->
                <Frame BorderColor="{StaticResource Primary}" 
                       HasShadow="True"
                       Padding="15"
                       CornerRadius="10">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="감지 모드" 
                               FontSize="18"
                               FontAttributes="Bold"/>
                        
                        <Label Text="{Binding ModeDescription}"
                               FontSize="14"
                               TextColor="{StaticResource Gray600}"/>

                        <Grid ColumnDefinitions="*,*" 
                              RowDefinitions="Auto,Auto"
                              ColumnSpacing="10"
                              RowSpacing="10">
                            
                            <Button Grid.Row="0" Grid.Column="0"
                                    Text="🚇 출퇴근"
                                    Command="{Binding ChangeModeCommand}"
                                    CommandParameter="{x:Static models:DetectionMode.Commute}"
                                    BackgroundColor="{StaticResource Primary}"/>
                            
                            <Button Grid.Row="0" Grid.Column="1"
                                    Text="💼 사무실"
                                    Command="{Binding ChangeModeCommand}"
                                    CommandParameter="{x:Static models:DetectionMode.Office}"
                                    BackgroundColor="{StaticResource Secondary}"/>
                            
                            <Button Grid.Row="1" Grid.Column="0"
                                    Text="👥 회의"
                                    Command="{Binding ChangeModeCommand}"
                                    CommandParameter="{x:Static models:DetectionMode.Meeting}"
                                    BackgroundColor="{StaticResource Tertiary}"/>
                            
                            <Button Grid.Row="1" Grid.Column="1"
                                    Text="⚙️ 사용자 정의"
                                    Command="{Binding ChangeModeCommand}"
                                    CommandParameter="{x:Static models:DetectionMode.Custom}"
                                    BackgroundColor="{StaticResource Gray500}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- 설명 카드 -->
                <Frame BorderColor="{StaticResource Gray300}" 
                       HasShadow="False"
                       Padding="15"
                       CornerRadius="10"
                       BackgroundColor="{StaticResource Gray100}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="ℹ️ 사용 방법" 
                               FontSize="16"
                               FontAttributes="Bold"/>
                        <Label FontSize="12" TextColor="{StaticResource Gray900}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="1. 감지를 활성화하면 전면 카메라로 얼굴을 감지합니다.&#10;"/>
                                    <Span Text="2. 여러 얼굴이 감지되거나 측면에서 보는 사람이 감지되면 경고합니다.&#10;"/>
                                    <Span Text="3. 모드에 따라 다른 민감도로 동작합니다.&#10;"/>
                                    <Span Text="4. 설정에서 보호 방법을 변경할 수 있습니다.&#10;"/>
                                    <Span Text="5. '감지 테스트' 버튼으로 실시간 카메라와 감지 상태를 확인하세요." FontAttributes="Bold"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </VerticalStackLayout>
                </Frame>

            </VerticalStackLayout>
        </ScrollView>

        <!-- 하단 버튼 -->
        <Grid Grid.Row="2" 
              Margin="20"
              ColumnDefinitions="*,*"
              ColumnSpacing="10">
            <Button Text="⚙️ 설정"
                    Command="{Binding OpenSettingsCommand}"
                    BackgroundColor="{StaticResource Gray500}"
                    TextColor="White"/>
            <Button Grid.Column="1"
                    Text="{Binding IsCameraModeVisible, Converter={StaticResource BoolToTextConverter}}"
                    Command="{Binding ToggleCameraModeCommand}"
                    BackgroundColor="{StaticResource Tertiary}"
                    TextColor="White"/>
        </Grid>

        <!-- 보호 오버레이/위장 화면 -->
        <Grid Grid.RowSpan="3" 
              x:Name="ProtectionOverlay"
              IsVisible="{Binding IsProtectionOverlayVisible}"
              InputTransparent="False">
            
            <!-- 블러 효과 (Blur) -->
            <Grid x:Name="BlurOverlay" 
                  IsVisible="False"
                  BackgroundColor="#F0FFFFFF">
                <VerticalStackLayout Spacing="20" 
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center">
                    <Label Text="⚠️ 엿보기 감지됨!" 
                           FontSize="32"
                           FontAttributes="Bold"
                           TextColor="#333"
                           HorizontalOptions="Center"/>
                    
                    <Button Text="확인"
                            Command="{Binding DismissProtectionCommand}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            WidthRequest="120"/>
                </VerticalStackLayout>
            </Grid>

            <!-- 화면 가리기 (Cover) -->
            <Grid x:Name="CoverOverlay" 
                  IsVisible="False"
                  BackgroundColor="Black">
                <VerticalStackLayout Spacing="20" 
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center">
                    <Label Text="⚠️" 
                           FontSize="72"
                           TextColor="White"
                           HorizontalOptions="Center"/>
                    <Label Text="엿보기 감지됨" 
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"/>
                    
                    <Button Text="확인"
                            Command="{Binding DismissProtectionCommand}"
                            BackgroundColor="White"
                            TextColor="Black"
                            WidthRequest="120"
                            Margin="0,20,0,0"/>
                </VerticalStackLayout>
            </Grid>

            <!-- 위장 화면 컨테이너 (Disguise) -->
            <ContentView x:Name="DisguiseContainer" 
                         IsVisible="False"/>

        </Grid>

        <!-- 감지 테스트 전체 화면 -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding IsCameraModeVisible}"
              BackgroundColor="Black"
              RowDefinitions="*,Auto">
            
            <!-- 카메라 프리뷰 전체 영역 (제한 없음) -->
            <ContentView x:Name="CameraPreviewContainer"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"/>
            
            <!-- 감지 상태 오버레이 -->
            <VerticalStackLayout Grid.RowSpan="2"
                                 VerticalOptions="Start"
                                 Margin="20"
                                 Spacing="10">
                <!-- 상태 헤더 -->
                <Frame Padding="15"
                       BackgroundColor="#CC000000"
                       CornerRadius="10"
                       HasShadow="False">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                        <Label Text="🔍"
                               FontSize="24"
                               VerticalOptions="Center"/>
                        <VerticalStackLayout Grid.Column="1">
                            <Label Text="감지 테스트 모드"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                            <Label Text="{Binding DetectionTestStatus}"
                                   FontSize="13"
                                   TextColor="#4CAF50"/>
                        </VerticalStackLayout>
                    </Grid>
                </Frame>

                <!-- 실시간 감지 상태 -->
                <Frame Padding="15"
                       BackgroundColor="#CC000000"
                       CornerRadius="10"
                       HasShadow="False">
                    <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                        <!-- 감지된 얼굴 수 -->
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Text="👤" FontSize="16"/>
                            <Label Grid.Column="1"
                                   Text="감지된 얼굴"
                                   TextColor="White"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   Margin="5,0"/>
                            <Label Grid.Column="2"
                                   Text="{Binding DetectedFaceCount}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#2196F3"/>
                        </Grid>

                        <!-- 서비스 상태 -->
                        <Grid Grid.Row="1" ColumnDefinitions="Auto,*">
                            <Label Text="🤖" FontSize="16"/>
                            <Label Grid.Column="1"
                                   Text="{Binding StatusMessage}"
                                   TextColor="White"
                                   FontSize="13"
                                   VerticalOptions="Center"
                                   Margin="5,0"/>
                        </Grid>

                        <!-- 감지 모드 -->
                        <Grid Grid.Row="2" ColumnDefinitions="Auto,*">
                            <Label Text="⚙️" FontSize="16"/>
                            <Label Grid.Column="1"
                                   Text="{Binding ModeDescription}"
                                   TextColor="White"
                                   FontSize="13"
                                   VerticalOptions="Center"
                                   Margin="5,0"/>
                        </Grid>
                    </Grid>
                </Frame>
            </VerticalStackLayout>

            <!-- 하단 종료 버튼 -->
            <Button Grid.Row="1"
                    Text="✖️ 감지 테스트 종료"
                    Command="{Binding ToggleCameraModeCommand}"
                    BackgroundColor="#d32f2f"
                    TextColor="White"
                    HeightRequest="60"
                    Margin="20,0,20,20"
                    FontSize="18"
                    FontAttributes="Bold"/>
        </Grid>
    </Grid>

</ContentPage>
